From 0abde5b123cf3c3784d27aec91186baaae50eeaa Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Thu, 19 Aug 2021 16:01:59 +0800
Subject: [PATCH] u-boot-lsi: axxia: introduce solution for CVE-2017-5715

This patch is based on c2ca3fdfb916 ("ARM: Introduce ability to enable
invalidate of BTB with ICIALLU on Cortex-A15 for CVE-2017-5715") of
upstream u-boot.

This is to fix the warning which can be observed when kernel booting:
"CPU1: Spectre v2: firmware did not set auxiliary control register IBE bit, system vulnerable"

Upstream-Status: Inappropriate [WR Linux specific change]

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 board/lsi/axxia-arm/lowlevel.S | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/board/lsi/axxia-arm/lowlevel.S b/board/lsi/axxia-arm/lowlevel.S
index 5dfe2a713a..09b3fa5359 100644
--- a/board/lsi/axxia-arm/lowlevel.S
+++ b/board/lsi/axxia-arm/lowlevel.S
@@ -359,6 +359,14 @@ lowlevel_init:
 
 #else
 
+	@@
+	@ fix CVE_2017_5715 by setting bit 0 in the ACTLR.
+
+	mrc	p15, 0, r0, c1, c0, 1
+	@ Enable invalidates of BTB to fix ARM_CORTEX_A15_CVE_2017_5715
+	orr	r0, r0, #(1 << 0)
+	mcr	p15, 0, r0, c1, c0, 1
+
 	@@
 	@ Get the CPU number.
 
-- 
2.25.1

